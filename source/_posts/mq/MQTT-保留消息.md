---
title: MQTT 保留消息
date: 2019-04-16 10:38:51
tags:
---

【翻译】

在MQTT中，发布消息的客户端无法保证订阅客户端实际接收消息。发布客户端只能确保将消息安全地传递给代理。基本上，订阅客户端也是如此。连接和订阅主题的客户端无法保证发布客户端何时在其感兴趣的主题中发布消息。发布者可能需要几秒钟，几分钟或几小时才能在其中一个订阅主题中发送新消息。在下一条消息发布之前，订阅客户端对该主题的当前状态一无所知。这种情况是保留消息发挥作用的地方。

# 保留消息

***保留的消息是正常的MQTT消息，其中保留标志设置为true。代理存储最后保留的消息以及该主题的相应QoS。***订阅与保留消息主题匹配的主题模式的每个客户端在订阅后立即接收保留消息。代理仅为每个主题存储一条保留消息。

如果订阅客户端在他们订阅的主题模式中包含通配符，则即使保留消息的主题不是完全匹配，它也会收到保留的消息。以下是一个示例：客户端A向myhome / livingroom / temperature发布保留的消息 。一段时间后，客户B订阅了 myhome /＃。客户B 在订阅myhome /＃后直接收到myhome / livingroom / temperature保留消息。客户端B（订阅客户端）可以看到该消息是保留消息，因为代理发送保留消息并将保留标志设置为true。客户端可以决定如何处理保留的消息。


***保留的消息有助于新订阅的客户端在订阅主题后立即获得状态更新。保留的消息消除了等待发布客户端发送下一个更新***

换句话说，关于主题的保留消息是最后已知的良好值。保留的消息不必是最后一个值，但它必须是保留标志设置为true的最后一条消息。


***重要的是要理解保留的消息与持久性会话无关**。一旦代理存储了保留消息，就只有一种方法可以将其删除。

# 发送保留的消息

从开发人员的角度来看，发送保留的消息非常简单直接。你刚才设置的 保留标志一个的***MQTT发布消息为真。***通常，您的客户端库提供了一种设置此标志的简便方法。

# 删除保留的消息

还有一种非常简单的方法可以删除主题的保留消息：在要删除先前保留消息的主题上发送带有零字节有效负载的保留消息。代理删除保留的消息，新订阅者不再获取该主题的保留消息。通常，甚至不需要删除，因为每个新保留的消息都会覆盖前一个消息。

# 为什么以及何时使用保留消息？

***当您希望新连接的订阅者立即接收消息时（无需等到发布客户端发送下一条消息），保留的消息才有意义。***这对于各个主题的组件或设备的状态更新非常有用。例如，device1的状态位于主题myhome / devices / device1 / status上。使用保留消息时，主题的新订阅者在订阅后立即获得设备的状态（在线/离线）。对于以间隔，温度，GPS坐标和其他数据发送数据的客户端也是如此。***如果没有保留消息，新订阅者将在发布间隔之间保持黑暗状态。***使用保留的消息有助于立即为连接的客户端提供最后的良好价值。