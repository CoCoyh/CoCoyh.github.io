---
title: MQTT 主题设计
date: 2019-04-15 16:35:36
tags: 消息协议
---

【翻译】

欢迎来到MQTT Essentials的第五部分。关于MQTT协议的核心功能和概念的十部分博客系列。在这篇文章中，我们关注MQTT主题和最佳实践。正如我们已经提到的，MQTT代理使用消息主题来决定哪个客户端接收哪个消息。我们还会查看SYS主题，这些主题是揭示有关代理本身的信息的特殊主题。让我们开始吧。

# 话题
在MQTT中，主题一词是指代理用来过滤每个连接客户端的消息的UTF-8字符串。该主题包含一个或多个主题级别。每个主题级别由正斜杠（主题级别分隔符）分隔。

```
myhome/groundfloor/livingroom/temperate
```

与消息队列相比，MQTT主题非常轻量级。客户端在发布或订阅它之前不需要创建所需的主题。代理接受每个有效主题而无需事先初始化。

以下是一些主题示例：

```
myhome / groundfloor / livingroom /温度
美国/加利福尼亚/旧金山/硅谷
5ff4a2ce-e485-40f4-826c-b1a5d81be9b6 / status 
德国/巴伐利亚/汽车/ 2382340923453 /纬度
```

请注意，每个主题必须至少包含1个字符，并且主题字符串允许空格。主题区分大小写。例如，_myhome / temperature和_MyHome / Temperature是两个不同的主题。此外，单独的正斜杠是一个有效的主题。

# 通配符

当客户端订阅主题时，它可以订阅已发布消息的确切主题，也可以使用通配符同时订阅多个主题。通配符只能用于订阅主题，而不能用于发布消息。有两种不同的通配符：_single-level和_multi-level。

单级：+
顾名思义，单级通配符取代了一个主题级别。加号表示主题中的单级通配符。

```
myhome/groundfloor/+/temperate
```

如果主题包含任意字符串而不是通配符，则任何主题都会将主题与单级通配符匹配。例如，订阅_myhome / groundfloor / + / temperature可以产生以下结果：

```
myhome/groundfloor/livingroom/temperate
myhome/groundfloor/kitchen/temperate
```

# 多级： #

多级通配符涵盖许多主题级别。哈希符号表示主题中的多级通配符。要使代理确定哪些主题匹配，必须将多级通配符放在主题中的最后一个字符，并以正斜杠开头。

```
myhome/groundfloor/#
```

```
myhome/groundfloor/living/temperate
myhome/groundfloor/kitchen/temperate
myhome/groundfloor/kitchen/brightness
```
当客户端使用多级通配符订阅主题时，无论主题有多长或多深，它都会接收以通配符之前的模式开头的主题的所有消息。如果仅指定多级通配符作为主题（_＃），则会收到发送到MQTT代理的所有消息。如果您期望高吞吐量，单独使用多级通配符进行订阅是一种反模式（请参阅下面的最佳做法）

# 以$开头的主题
通常，您可以根据需要为MQTT主题命名。但是，有一个例外：__以$符号开头的主题具有不同的用途.__当您将多级通配符作为主题（＃）订阅时，这些主题不是订阅的一部分。$ -symbol主题保留用于MQTT代理的内部统计信息。客户端无法向这些主题发布消息。目前，这些主题尚未正式标准化。通常，$ SYS /用于以下所有信息，但代理实现方式各不相同。$ SYS-topics的一个建议是在 MQTT GitHub wiki中。这里有些例子：

```
$ SYS/broker/clients/connected
$ SYS/broker/clients/disconnected
$ SYS/broker/message/sent
$ SYS/broker/uptime
```

# 摘要

这些是MQTT消息主题的基础知识。如您所见，MQTT主题是动态的，并提供了极大的灵活性。在实际应用程序中使用通配符时，您应该注意一些挑战。我们收集了我们在各种项目中广泛使用MQTT所学到的最佳实践，并随时接受有关这些实践的建议或讨论。使用评论开始对话，让我们知道您的最佳实践，或者如果您不同意我们的最佳实践！

# 最佳做法

切勿使用前导斜线
MQTT中允许使用前导斜杠。例如， / myhome / groundfloor / livingroom。但是，前导斜杠会在前面引入一个零字符的不必要的主题级别。零不会带来任何好处，往往会导致混淆。

切勿在主题中使用空格
空间是每个程序员的天敌。当事情不按照他们应该的方式进行时，空间使得阅读和调试主题变得更加困难。与前导斜杠一样，仅仅因为允许某些东西，并不意味着它应该被使用。UTF-8有许多不同的空白类型，应避免使用这种不常见的字符。

保持主题简洁明了
每个主题都包含在使用它的每条消息中。让您的主题尽可能简洁明了。对于小型设备，每个字节数和主题长度都会产生很大影响。

仅使用ASCII字符，避免使用不可打印的字符
由于非ASCII UTF-8字符经常显示不正确，因此很难找到与字符集相关的拼写错误或问题。除非绝对必要，否则我们建议避免在主题中使用非ASCII字符。

在主题中嵌入唯一标识符或客户端ID
在主题中包含发布客户端的唯一标识符非常有用。主题中的唯一标识符可帮助您识别发送邮件的人员。嵌入式ID可用于强制执行授权。只允许与主题中具有相同客户端ID的客户端发布到该主题。例如，允许具有_client1 ID的客户端发布到_client1 / status，但不允许发布到_client2 / status。

不订阅＃
有时，有必要订阅通过代理传输的所有消息。例如，将所有消息保存到数据库中。不要使用MQTT客户端订阅代理上的所有消息并订阅多级通配符。通常，订阅客户端无法处理由此方法产生的消息负载（特别是如果您有大量吞吐量）。我们的建议是在MQTT代理中实现扩展。例如，使用HiveMQ的插件系统，您可以挂钩HiveMQ的行为并添加一个异步例程来处理每个传入的消息并将其持久保存到数据库。

不要忘记可扩展性
主题是一个灵活的概念，没有必要以任何方式预分配它们。但是，发布者和订阅者都需要了解该主题。重要的是要考虑如何扩展主题以允许新功能或产品。例如，如果您的智能家居解决方案添加了新传感器，则应该可以将这些传感器添加到主题树，而无需更改整个主题层次结构。

使用特定主题，而不是一般主题
命名主题时，请勿以与队列相同的方式使用它们。尽可能具体。例如，如果您的起居室有三个传感器，请为_myhome / livingroom / temperature，_myhome / livingroom / brightness和_myhome / livingroom / humidity创建主题。不要在_myhome / livingroom上发送所有值。对所有消息使用单个主题是反模式。特定命名还使您可以使用其他MQTT功能，例如保留的消息。有关保留消息的更多信息，请参阅Essentials系列的第8部分。