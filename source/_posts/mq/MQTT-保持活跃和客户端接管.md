---
title: MQTT 保持活跃和客户端接管
date: 2019-04-16 16:04:48
tags: 消息协议
---

【译文】

# 半开TCP连接的问题

MQTT基于传输控制协议（TCP）。该协议确保数据包以“可靠，有序和错误检查”的方式通过互联网传输。然而，通信方之间的转移有时可能会失去同步。例如，如果其中一方崩溃或传输错误。在TCP中，这种不完整连接状态称为半开连接。需要记住的重要一点是，通信的一方继续运作，并且不会通知另一方的失败。仍然连接的一方不断尝试发送消息并等待确认。

正如Andy Stanford-Clark（MQTT协议的发明者）所指出的那样，半开放连接的问题在移动网络中有所增加：

```
“虽然理论上TCP / IP会在套接字断开时通知您，但实际上，尤其是移动和卫星链接等常常”伪造“TCP无线并在每端都放置标头的情况下，TCP很可能会出现问题。会议到“黑洞”，即它看起来仍然是开放的，但事实上只是把你写的任何东西倾倒在地板上。“
```

Andy Stanford-Clark关于“ 为什么需要保持活力？“（来源）

# MQTT保持活力

MQTT包括一个保持活动功能，它为半开连接问题提供了一种解决方法（或者至少可以评估连接是否仍然打开）。

保持活动状态可确保代理和客户端之间的连接仍处于打开状态，并且代理和客户端知道已连接。当客户端建立与代理的连接时，客户端以秒为单位向代理传递时间间隔。此时间间隔定义代理和客户端可能无法相互通信的最长时间。

MQTT规范说明如下：

```
“保持活动...是客户端完成发送一个控制数据包的点与它开始发送下一个控制数据包的点之间允许经过的最长时间间隔。客户有责任确保间隔时间间隔。正在发送的控制数据包之间不会超过保持活动值。如果没有发送任何其他控制数据包，客户端必须发送PINGREQ数据包。“
```

***只要频繁地交换消息并且不超过保持活动间隔，就不需要发送额外的消息来确定连接是否仍然是打开的。***

如果客户端在保持活动期间没有发送消息，它必须向代理发送PINGREQ数据包以确认它是否可用并确保代理仍然可用。

***代理必须在保持活动间隔的一倍半内断开不发送消息或PINGREQ数据包的客户端。***同样，如果客户端在合理的时间内没有收到代理的响应，则应该关闭该连接。

## 保持活力

让我们仔细看看保持活跃的消息。保持活动功能使用两个数据包：

PINGREQ
![](images/pingreq.png)

PINGREQ由客户端发送，并向代理指示客户端仍处于活动状态。如果客户端不发送任何其他类型的数据包（例如，PUBLISH或SUBSCRIBE数据包），则客户端必须向代理发送PINGREQ数据包。客户端可以在想要确认网络连接仍然存在的任何时候发送PINGREQ数据包。PINGREQ数据包不包含有效负载。

PINGRESP
![](images/pingresp.png)

当代理收到PINGREQ数据包时，代理必须使用PINGRESP数据包进行回复，以向客户端显示它仍然可用。PINGRESP数据包也不包含有效负载。


## 很高兴知道

- 如果代理没有从客户端收到PINGREQ或任何其他数据包，则代理关闭连接并发送最后的遗嘱和遗嘱消息（如果客户指定了LWT）。
- MQTT客户端负责设置适当的保持活动值。例如，客户端可以将保持活动间隔调整为其当前信号强度。
- 最大值保持活动时间为18小时12分15秒。
- 如果保持活动间隔为0，则保持活动机制被停用。

# 客户接管

通常，断开连接的客户端会尝试重新连接。有时，经纪人仍然为客户提供半开连接。在MQTT中，如果代理检测到半开连接，则执行“客户端接管”。代理关闭先前与同一客户端的连接（由客户端标识符确定），并与客户端建立新连接。此行为可确保半开连接不会阻止断开连接的客户端重新建立连接。

