---
title: MQTT 持久会话和排队消息
date: 2019-04-15 17:59:19
tags: 消息协议
---

【翻译】

在这篇文章中，我们将讨论MQTT中的持久会话和消息队列。虽然MQTT根据定义不是消息队列，但它可以为客户端排队消息。我们会告诉你如何。

#持久会话

要从MQTT代理接收消息，客户端将连接到代理并创建对其感兴趣的主题的预订。如果客户端和代理之间的连接在非持久会话期间中断，则这些主题将丢失，客户端需要在重新连接时再次订阅。每次连接中断时重新订阅都是资源有限的受限客户端的负担。为避免此问题，客户端可以在连接到代理时请求持久会话。持久会话保存与代理上的客户端相关的所有信息。客户端在与代理建立连接时提供的clientId标识会话（更多详细信息）。

## 什么存储在持久会话中

在持久会话中，代理存储以下信息（即使客户端处于脱机状态）。当客户端重新连接时，信息立即可用。

- 会话的存在（即使没有订阅）

- 客户端的所有订阅信息

- 客户端尚未确认的服务质量（QoS）1或2中的所有信息流

- 客户端在脱机时丢失的所有新Qos1或2消息

- 从客户端收到的所有尚未完全确认的Qos2消息

# 你如何开始或结束持久会话

当客户端连接到代理时，它可以请求持久会话。客户端使用cleanSession标志告诉代理它需要什么类型的会话：

当clean session标志设置为true时，客户端不需要持久会话。如果客户端因任何原因断开连接，则从先前的持久会话排队的所有信息和消息都将丢失。
当clean session标志设置为false时，代理会为客户端创建持久会话。保留所有信息和消息，直到客户端下次请求干净会话为止。如果clean session标志设置为false并且代理已经具有可用于客户端的会话，则它使用现有会话并将先前排队的消息传递到客户端。

有关客户端和代理之间的连接建立的更多信息，

# 客户端如何知道会话是否已存储

从MQTT 3.1.1开始，来自代理的CONNACK消息包含会话存在标志。此标志告诉客户端先前建立的会话是否仍在代理上可用

# 客户端的持久会话

与代理类似，每个MQTT客户端也必须存储持久会话。当客户端请求服务器保存会话数据时，客户端负责存储以下信息

- QoS 1或2流中的所有消息，尚未由代理确认。

- 那从代理接收的所有QoS 2消息尚未完全确认。

# 最佳做法

以下是一些可以帮助您决定何时使用持久会话或干净会话的准则：

## 持久会话

- 客户端必须从特定主题获取所有消息，即使它处于脱机状态。您希望代理为客户端排队消息，并在客户端重新联机后立即发送消息。

- 客户资源有限。您希望代理存储客户端的订阅信息并快速恢复中断的通信。

- 重新连接后，客户端需要恢复所有QoS 1和2发布消息。

## 清洁会话

- 客户端只需要向主题发布消息，客户端不需要订阅主题。您不希望代理存储会话信息或重试QoS 1和2消息的传输。

- 客户端不需要获取它未命中的消息。

# 经纪人存储消息多长时间？

人们经常会问经纪人存储会话的时间。简单的答案是：经纪人存储会话，直到客户端重新联机并收到消息。但是，如果客户长时间没有重新上线，会发生什么？ 通常，操作系统的内存限制是对邮件存储的主要限制。这种情况没有标准答案。正确的解决方案取决于您的使用案例。例如，在HiveMQ中，我们提供了清除排队消息的可能性。