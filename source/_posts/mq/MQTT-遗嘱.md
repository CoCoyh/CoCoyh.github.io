---
title: MQTT 遗嘱
date: 2019-04-16 15:40:35
tags: 消息协议
---

由于MQTT通常用于包含不可靠网络的场景中，因此可以合理地假设这些场景中的某些MQTT客户端偶尔会断开连接。由于连接断开，电池耗尽或许多其他原因，可能会发生不正常的断开连接。了解客户端是否正常（使用MQTT DISCONNECT消息）或不正常（没有断开连接消息）断开连接，可帮助您正确响应。最后遗嘱和遗嘱功能为客户提供了一种方式，以适当的方式响应不合适的断开连接。

# 遗嘱

在MQTT中，您使用最后遗嘱和遗嘱（LWT）功能来通知其他客户端有关非正常断开连接的客户端。每个客户端在连接到代理时都可以指定其最后一条消息。最后一条消息是具有主题，保留消息标志，QoS和有效负载的普通MQTT消息。代理存储消息，直到它检测到客户端已经非正常地断开连接。为了响应非正常断开连接，代理将last-will消息发送到last-will消息主题的所有子客户端。如果客户端使用正确的DISCONNECT消息正常断开连接，则代理将丢弃存储的LWT消息。

![](images/disconnect.png)

LWT可帮助您在客户端连接断开（或至少通知其他客户端有关脱机状态）时实施各种策略。

***如何为客户端指定LWT消息**

客户端可以在CONNECT消息中指定LWT消息，以启动客户端与代理之间的连接。

![](images/connect.png)

***经纪人什么时候发送LWT消息***

根据MQTT 3.1.1规范，代理必须在以下情况下分发客户端的LWT：

- 代理检测到I / O错误或网络故障。
- 客户端无法在定义的Keep Alive期间进行通信。
- 客户端在关闭网络连接之前不发送DISCONNECT数据包。
- 由于协议错误，代理关闭网络连接。

***最佳实践-何时使用LWT***

LWT是向其他订阅客户端通知另一个客户端意外丢失连接的好方法。在实际场景中，LWT通常与保留的消息组合以将客户端的状态存储在特定主题上。例如，client1首先向代理发送CONNECT消息，其lastWillMessage具有“ Offline ”作为有效负载，lastWillRetain标志设置为true，lastWillTopic设置为client1 / status。接下来，客户端发送PUBLISH消息，其中有效负载“ Online ”，并且保留标志设置为true到同一主题（client1 / status）。只要client1保持连接，新订阅的客户端到client1 / status主题就会收到“ Online”“留言。如果client1意外断开连接，则代理会发布LWT消息，并将有效负载“ Offline ”作为新保留的消息。在client1离线时订阅主题的客户端从代理接收LWT保留消息（“ 脱机 ”）。这种保留消息模式使其他客户端在特定主题的client1的当前状态上保持最新。

